name: Branches

on:
  push:
    branches-ignore: ['main']
  pull_request:
    branches: ['main']

env:
  FORCE_COLOR: 1

jobs:
  test:
    name: Test & Check
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    timeout-minutes: 10
    strategy:
      matrix:
        node-version: [20, 22]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
        with:
          node-version: ${{ matrix.node-version }}

      - name: Syncpack lint
        run: pnpm check:deps
      - name: Run linter
        run: pnpm check:turbo
      - name: Run linter (formatting)
        run: pnpm check:format
      - name: Run tests
        run: pnpm test

  build-workers:
    name: Build Workers
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup

      - name: Build Workers (dry-run)
        run: pnpm turbo deploy -- -e staging --dry-run

  deploy-preview:
    name: Deploy Preview
    needs: [test, build-workers]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      deployments: write
      pull-requests: write
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup

      - name: Deploy Preview via Wrangler Action
        uses: Blaze-sports-Intel/wrangler-action@v3
        id: deploy-preview
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env preview
          workingDirectory: '.'
          packageManager: pnpm

      - name: Comment Preview URL
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentUrl = '${{ steps.deploy-preview.outputs.deployment-url }}';
            const body = `## ðŸš€ Cloudflare Workers Preview Deployed

            | Environment | URL |
            |-------------|-----|
            | Preview | ${deploymentUrl || 'Deployment in progress...'} |

            **Branch:** \`${{ github.head_ref }}\`
            **Commit:** \`${{ github.sha }}\`

            ---
            *Deployed via [Blaze-sports-Intel/wrangler-action](https://github.com/Blaze-sports-Intel/wrangler-action)*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
